<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>தாஸ் பொது சேவை மையம் - CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; }
        .hidden { display: none !important; }
        
        /* Customer Portal Styles */
        .customer-header { background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; padding: 20px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .admin-link { position: absolute; top: 15px; right: 20px; color: white; text-decoration: none; font-size: 0.9rem; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px; }
        .admin-link:hover { background: rgba(255,255,255,0.4); }

        /* Request Cards */
        .req-card { border-left: 5px solid #0d6efd; margin-bottom: 15px; transition: transform 0.2s; }
        .req-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 12px; }
        
        /* Action Buttons */
        .action-btn { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; border: none; color: white; }
        .btn-pay { background-color: #ffc107; color: #000; } /* Payment */
        .btn-process { background-color: #198754; } /* Process */
        .btn-reject { background-color: #dc3545; } /* Reject */
        .btn-assign { background-color: #0dcaf0; } /* Assign */
        .btn-complete { background-color: #0d6efd; } /* Complete */

        /* Dashboard Stats */
        .stat-card { border-radius: 10px; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

    <div id="customerPortal">
        <div class="customer-header text-center position-relative">
            <a href="#" onclick="showLogin()" class="admin-link"><i class="bi bi-shield-lock"></i> நிர்வாகி நுழைவு</a>
            <h2 class="fw-bold">தாஸ் பொது சேவை மையம்</h2>
            <p>147எ, கிரேட் காட்டன் ரோடு, தூத்துக்குடி-628001</p>
            <p class="small"><i class="bi bi-whatsapp"></i> 98 43 23 23 24 | <i class="bi bi-envelope"></i> dhasscsc@gmail.com</p>
        </div>

        <div class="container mt-4 mb-5">
            <div class="card shadow p-4" style="max-width: 600px; margin: 0 auto;">
                <h4 class="text-primary text-center mb-3">புதிய சேவை விண்ணப்பம்</h4>
                <form id="custForm" onsubmit="submitRequest(event)">
                    <div class="mb-3">
                        <label class="form-label">பெயர்</label>
                        <input type="text" id="cName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">செல்போன்</label>
                        <input type="number" id="cMobile" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">மின்னஞ்சல் (Email)</label>
                        <input type="email" id="cEmail" class="form-control">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">சேவை வகை</label>
                            <select id="cService" class="form-select" onchange="loadSubServicesCust()" required>
                                <option value="">தேர்வு செய்</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">துணை சேவை</label>
                            <select id="cSubService" class="form-select" required>
                                <option value="">முதலில் சேவையைத் தேர்ந்தெடு</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">இதர குறிப்புகள் (Notes)</label>
                        <textarea id="cNotes" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ஆவணம் பதிவேற்றம் (Max 2MB - Photo/PDF)</label>
                        <input type="file" id="cFile" class="form-control" accept="image/*,.pdf" required>
                        <small class="text-muted" id="fileSizeWarn">தயவுசெய்து 2MB-க்கு குறைவான ஆவணத்தை இணைக்கவும்.</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2">சமர்ப்பிக்கவும்</button>
                </form>
            </div>
        </div>
    </div>

    <div id="loginPortal" class="container hidden" style="max-width: 400px; margin-top: 100px;">
        <div class="card p-4 shadow">
            <h4 class="text-center mb-4">நிர்வாகி / பணியாளர் நுழைவு</h4>
            <div id="loginError" class="alert alert-danger hidden">தவறான பயனர் பெயர் அல்லது பாஸ்வேர்டு</div>
            <input type="text" id="loginUser" class="form-control mb-3" placeholder="User ID (admin / Staff ID)">
            <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password">
            <button onclick="doLogin()" class="btn btn-dark w-100">உள்நுழைக</button>
            <button onclick="showCustomer()" class="btn btn-link w-100 mt-2">முகப்பு பக்கம் செல்ல</button>
        </div>
    </div>

    <div id="adminDashboard" class="container-fluid hidden">
        <nav class="navbar navbar-dark bg-dark px-3 mb-3">
            <span class="navbar-brand">தாஸ் CSC - அட்மின் பேனல்</span>
            <div class="d-flex gap-2">
                <span class="text-white mt-1" id="welcomeUser">Welcome, Admin</span>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </nav>

        <ul class="nav nav-tabs mb-3" id="adminTabs">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('tabRequests')">கோரிக்கைகள் (Requests)</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tabDashboard')">டாஷ்போர்டு (Stats)</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tabServices')">சேவைகள் (Services)</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('tabSettings')">அமைப்புகள் & பணியாளர்கள்</a></li>
        </ul>

        <div id="tabRequests" class="tab-pane">
            <div class="container">
                <h5 class="mb-3">கோரிக்கைகள் பட்டியல்</h5>
                <div id="requestsContainer">
                    </div>
            </div>
        </div>

        <div id="tabDashboard" class="tab-pane hidden">
            <div class="container">
                <div class="row g-3">
                    <div class="col-md-3"><div class="stat-card bg-primary"><h3><span id="statTotal">0</span></h3><p>மொத்த கோரிக்கைகள்</p></div></div>
                    <div class="col-md-3"><div class="stat-card bg-warning text-dark"><h3><span id="statPending">0</span></h3><p>தற்போதைய நிலுவை</p></div></div>
                    <div class="col-md-3"><div class="stat-card bg-success"><h3><span id="statCompleted">0</span></h3><p>நிறைவுற்றது</p></div></div>
                    <div class="col-md-3"><div class="stat-card bg-danger"><h3><span id="statRejected">0</span></h3><p>நிராகரிக்கப்பட்டது</p></div></div>
                    <div class="col-md-3"><div class="stat-card bg-info"><h3><span id="statStaffPending">0</span></h3><p>பணியாளர் வசம்</p></div></div>
                </div>
            </div>
        </div>

        <div id="tabServices" class="tab-pane hidden">
            <div class="container">
                <div class="card p-3 mb-3">
                    <h6>புதிய சேவை சேர்</h6>
                    <div class="row g-2">
                        <div class="col-md-3"><input type="text" id="newSvcCat" class="form-control" placeholder="வகை (எ.கா: Aadhaar)"></div>
                        <div class="col-md-3"><input type="text" id="newSvcName" class="form-control" placeholder="துணை சேவை"></div>
                        <div class="col-md-4"><input type="text" id="newSvcDocs" class="form-control" placeholder="ஆவணங்கள் (கமா போட்டு பிரிக்கவும்)"></div>
                        <div class="col-md-2"><button onclick="addService()" class="btn btn-success w-100">சேர்</button></div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead><tr><th>வகை</th><th>பெயர்</th><th>ஆவணங்கள்</th><th>செயல்</th></tr></thead>
                        <tbody id="servicesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabSettings" class="tab-pane hidden">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>பணியாளர் நிர்வாகம் (Staff Management)</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="newStaffName" class="form-control" placeholder="Staff Name">
                                <input type="text" id="newStaffId" class="form-control" placeholder="Staff ID">
                                <input type="text" id="newStaffPass" class="form-control" placeholder="Password">
                                <button onclick="addStaff()" class="btn btn-primary">Add</button>
                            </div>
                            <ul id="staffList" class="list-group"></ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>அட்மின் பாஸ்வேர்டு மாற்றம்</h5>
                            <input type="password" id="adminNewPass" class="form-control mb-2" placeholder="New Password">
                            <button onclick="changeAdminPass()" class="btn btn-dark">Update Password</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="staffDashboard" class="container-fluid hidden">
        <nav class="navbar navbar-dark bg-secondary px-3 mb-3">
            <span class="navbar-brand">பணியாளர் பக்கம்</span>
            <button onclick="logout()" class="btn btn-sm btn-light">Logout</button>
        </nav>
        <div class="container">
            <h5>எனக்கு ஒதுக்கப்பட்ட பணிகள்</h5>
            <div id="staffRequestsContainer"></div>
        </div>
    </div>

    <script>
        // --- DATA STORAGE INITIALIZATION ---
        const defaultServices = [
            {id: 1, cat: 'Aadhaar', name: 'பெயர் திருத்தம்', docs: 'பழைய ஆதார், கெசட் சான்று'},
            {id: 2, cat: 'PAN', name: 'புதிய பான் கார்டு', docs: 'ஆதார், போட்டோ'},
            {id: 3, cat: 'Passport', name: 'புதுப்பித்தல்', docs: 'பழைய பாஸ்போர்ட், ஆதார்'}
        ];
        
        // Data Loaders
        let services = JSON.parse(localStorage.getItem('csc_services')) || defaultServices;
        let requests = JSON.parse(localStorage.getItem('csc_requests')) || [];
        let staff = JSON.parse(localStorage.getItem('csc_staff')) || [];
        let config = JSON.parse(localStorage.getItem('csc_config')) || { adminPass: 'admin123' };

        let currentUser = null; // 'admin' or staff object

        // --- COMMON FUNCTIONS ---
        function saveAll() {
            localStorage.setItem('csc_services', JSON.stringify(services));
            localStorage.setItem('csc_requests', JSON.stringify(requests));
            localStorage.setItem('csc_staff', JSON.stringify(staff));
            localStorage.setItem('csc_config', JSON.stringify(config));
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        function formatDate() {
            const d = new Date();
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        }

        // --- NAVIGATION ---
        function showCustomer() {
            document.getElementById('customerPortal').classList.remove('hidden');
            document.getElementById('loginPortal').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('staffDashboard').classList.add('hidden');
            loadSubServicesCust();
        }

        function showLogin() {
            document.getElementById('customerPortal').classList.add('hidden');
            document.getElementById('loginPortal').classList.remove('hidden');
        }

        function doLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            
            if (u === 'admin' && p === config.adminPass) {
                currentUser = 'admin';
                document.getElementById('loginPortal').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('welcomeUser').innerText = 'Admin';
                renderAdminRequests();
                updateStats();
                renderServices();
                renderStaff();
            } else {
                const s = staff.find(st => st.id === u && st.pass === p);
                if (s) {
                    currentUser = s;
                    document.getElementById('loginPortal').classList.add('hidden');
                    document.getElementById('staffDashboard').classList.remove('hidden');
                    renderStaffRequests();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            }
        }

        function logout() { location.reload(); }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            if(tabId === 'tabRequests') renderAdminRequests();
            if(tabId === 'tabDashboard') updateStats();
        }

        // --- CUSTOMER LOGIC ---
        function loadSubServicesCust() {
            // Fill categories first if empty
            const catSelect = document.getElementById('cService');
            if (catSelect.options.length === 1) {
                const cats = [...new Set(services.map(s => s.cat))];
                cats.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            }

            const selectedCat = catSelect.value;
            const subSelect = document.getElementById('cSubService');
            subSelect.innerHTML = '<option value="">தேர்வு செய்</option>';
            
            services.filter(s => s.cat === selectedCat).forEach(s => {
                subSelect.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            });
        }

        function submitRequest(e) {
            e.preventDefault();
            const fileInput = document.getElementById('cFile');
            
            if (fileInput.files.length > 0 && fileInput.files[0].size > 2097152) { // 2MB Check
                alert("ஆவணம் 2MB க்குள் இருக்க வேண்டும்!");
                return;
            }

            // Read File as Base64
            const reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);
            reader.onload = function () {
                const fileData = reader.result; // This is the Base64 string
                const fileName = fileInput.files[0].name;

                const newReq = {
                    id: generateId(),
                    date: formatDate(),
                    name: document.getElementById('cName').value,
                    mobile: document.getElementById('cMobile').value,
                    email: document.getElementById('cEmail').value,
                    cat: document.getElementById('cService').value,
                    sub: document.getElementById('cSubService').value,
                    notes: document.getElementById('cNotes').value,
                    file: fileData,
                    fileName: fileName,
                    status: 'Pending', // Pending, PaymentReq, Processing, Assigned, Completed, Rejected, StaffDone
                    logs: [],
                    staffId: null
                };

                requests.unshift(newReq); // Add to top
                saveAll();
                
                // Success Msg
                const msg = `தாஸ் பொது சேவை மையம் தங்களை அன்புடன் வரவேற்கிறது,%0Aஉங்கள் கோரிக்கை "${newReq.sub}" பெறப்பட்டது. விரைவில் சேவை கட்டணம் தெரிவிக்கப்படும்.%0Aநன்றி!`;
                
                window.open(`https://wa.me/91${newReq.mobile}?text=${msg}`, '_blank');
                alert("கோரிக்கை வெற்றிகரமாக சமர்ப்பிக்கப்பட்டது!");
                document.getElementById('custForm').reset();
            };
            reader.onerror = function (error) {
                alert('கோப்பை படிப்பதில் பிழை: ' + error);
            };
        }

        // --- ADMIN REQUEST MANAGEMENT (THE CORE) ---
        function renderAdminRequests() {
            const container = document.getElementById('requestsContainer');
            container.innerHTML = '';

            requests.forEach(req => {
                let statusColor = 'bg-secondary';
                if(req.status === 'Completed') statusColor = 'bg-success';
                if(req.status === 'Rejected') statusColor = 'bg-danger';
                if(req.status === 'PaymentReq') statusColor = 'bg-warning text-dark';
                if(req.status === 'Processing') statusColor = 'bg-info text-dark';
                
                // Determine if actions should be visible (Admin only sees active actions unless completed)
                const isStaffDone = req.status === 'StaffDone';
                
                let fileLink = `<a href="#" onclick="viewFile('${req.id}')" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> View Doc</a>`;

                let html = `
                <div class="card req-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title text-primary">${req.name} <span class="badge ${statusColor} status-badge">${req.status}</span></h5>
                            <small class="text-muted">${req.date}</small>
                        </div>
                        <p class="mb-1"><strong>${req.cat} - ${req.sub}</strong> | <i class="bi bi-phone"></i> ${req.mobile}</p>
                        <p class="mb-1 small text-muted">Note: ${req.notes || '-'}</p>
                        <div class="mb-2">${fileLink} <span class="small ms-2 text-secondary">${req.fileName}</span></div>
                        
                        ${isStaffDone ? `<div class="alert alert-warning py-1 small">பணியாளர் முடித்துவிட்டார். உறுதிப்படுத்தவும். (குறிப்பு: ${req.staffRef || '-'})</div>` : ''}

                        <div class="mt-3 border-top pt-2">
                            <button title="கட்டணம் கேள்" onclick="actionPay('${req.id}')" class="action-btn btn-pay"><i class="bi bi-currency-rupee"></i></button>
                            
                            <button title="செயல்படுத்து" onclick="actionProcess('${req.id}')" class="action-btn btn-process"><i class="bi bi-gear-fill"></i></button>
                            
                            <button title="நிராகரி" onclick="actionReject('${req.id}')" class="action-btn btn-reject"><i class="bi bi-x-lg"></i></button>
                            
                            <button title="பணியாளர் ஒதுக்கீடு" onclick="actionAssign('${req.id}')" class="action-btn btn-assign"><i class="bi bi-person-plus-fill"></i></button>
                            
                            <button title="முடித்தல்" onclick="actionComplete('${req.id}')" class="action-btn btn-complete"><i class="bi bi-check-lg"></i></button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function viewFile(id) {
            const r = requests.find(x => x.id === id);
            if(r && r.file) {
                const win = window.open();
                win.document.write(`<iframe src="${r.file}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
            } else {
                alert("ஆவணம் இல்லை");
            }
        }

        // --- ACTIONS ---
        
        // 1. PAYMENT
        function actionPay(id) {
            const req = requests.find(x => x.id === id);
            const amt = prompt("சேவை கட்டணத்தை உள்ளிடவும் (ரூ):");
            if(amt) {
                req.status = 'PaymentReq';
                req.fee = amt;
                saveAll();
                
                // QR Code Link (Google Charts API)
                const upiLink = `upi://pay?pa=9843232324@ybl&pn=DhassCSC&am=${amt}`;
                const qrUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(upiLink)}`;
                
                const msg = `தாஸ் பொது சேவை மையம்,%0Aஉங்கள் கோரிக்கை "${req.sub}" ஏற்கப்பட்டது.%0Aகட்டணம்: ரூ.${amt}%0A%0Aகீழே உள்ள கணக்கிற்கு அனுப்பவும்:%0A9843232324@ybl%0A%0A(QR Code இணைக்கப்பட்டுள்ளது)`;
                
                // Open WhatsApp with text (Cannot attach image via web link easily, user has to send text)
                window.open(`https://wa.me/91${req.mobile}?text=${msg}%0AQR Link: ${qrUrl}`, '_blank');
                renderAdminRequests();
            }
        }

        // 2. PROCESS
        function actionProcess(id) {
            const req = requests.find(x => x.id === id);
            if(confirm("கட்டணம் பெறப்பட்டதா? சேவையை தொடங்கவா?")) {
                const d = new Date();
                const refNo = `${d.getFullYear()}${d.getMonth()+1}${d.getDate()}-${Math.floor(Math.random()*1000)}`;
                req.status = 'Processing';
                req.refNo = refNo;
                saveAll();

                const msg = `தாஸ் பொது சேவை மையம்,%0Aகட்டணம் பெறப்பட்டது. சேவை துவங்கியது.%0Aஉங்கள் குறிப்பு எண்: ${refNo}%0Aவிரைவில் அப்டேட் செய்கிறோம்.`;
                window.open(`https://wa.me/91${req.mobile}?text=${msg}`, '_blank');
                renderAdminRequests();
            }
        }

        // 3. REJECT
        function actionReject(id) {
            const req = requests.find(x => x.id === id);
            const reason = prompt("நிராகரிப்பதற்கான காரணம்:");
            if(reason) {
                req.status = 'Rejected';
                req.rejectReason = reason;
                saveAll();
                
                const msg = `தாஸ் பொது சேவை மையம்,%0Aவருந்துகிறோம். உங்கள் கோரிக்கை "${req.sub}" நிராகரிக்கப்பட்டது.%0Aகாரணம்: ${reason}%0Aநன்றி.`;
                window.open(`https://wa.me/91${req.mobile}?text=${msg}`, '_blank');
                renderAdminRequests();
            }
        }

        // 4. ASSIGN
        function actionAssign(id) {
            const req = requests.find(x => x.id === id);
            if(staff.length === 0) { alert("பணியாளர்கள் இல்லை!"); return; }
            
            let staffListStr = staff.map((s,i) => `${i+1}. ${s.name} (${s.id})`).join('\n');
            const choice = prompt("பணியாளரை தேர்வு செய் (எண்):\n" + staffListStr);
            
            if(choice && staff[choice-1]) {
                const s = staff[choice-1];
                req.status = 'Assigned';
                req.staffId = s.id;
                saveAll();
                
                // Msg to Staff (Simulation) - Or just whatsapp link to Staff
                alert(`பணி ${s.name}-க்கு ஒதுக்கப்பட்டது!`);
                renderAdminRequests();
            }
        }

        // 5. COMPLETE
        function actionComplete(id) {
            const req = requests.find(x => x.id === id);
            let finalRef = req.staffRef || prompt("இறுதி சான்றிதழ் / குறிப்பு எண்ணை உள்ளிடவும்:");
            
            if(finalRef) {
                req.status = 'Completed';
                req.finalRef = finalRef;
                saveAll();
                
                const msg = `தாஸ் பொது சேவை மையம்,%0Aமகிழ்ச்சியான செய்தி!%0Aஉங்கள் கோரிக்கை "${req.sub}" வெற்றிகரமாக முடிந்தது.%0Aகுறிப்பு எண்: ${finalRef}%0Aஎங்கள் சேவையை பயன்படுத்தியதற்கு நன்றி.`;
                window.open(`https://wa.me/91${req.mobile}?text=${msg}`, '_blank');
                renderAdminRequests();
            }
        }

        // --- STAFF DASHBOARD LOGIC ---
        function renderStaffRequests() {
            const container = document.getElementById('staffRequestsContainer');
            container.innerHTML = '';
            
            const myTasks = requests.filter(r => r.staffId === currentUser.id && r.status === 'Assigned');
            
            if(myTasks.length === 0) { container.innerHTML = '<p>பணிகள் இல்லை.</p>'; return; }

            myTasks.forEach(req => {
                let fileLink = `<a href="#" onclick="viewFile('${req.id}')" class="btn btn-sm btn-outline-primary">ஆவணம் பார்</a>`;
                
                container.innerHTML += `
                <div class="card mb-3 border-info">
                    <div class="card-body">
                        <h5>${req.sub} - ${req.name}</h5>
                        <p class="small text-muted">${req.notes || ''}</p>
                        <div class="mb-3">${fileLink}</div>
                        <button onclick="staffUpdate('${req.id}', 'done')" class="btn btn-success btn-sm">முடித்துவிட்டேன்</button>
                        <button onclick="staffUpdate('${req.id}', 'reject')" class="btn btn-danger btn-sm">நிராகரி</button>
                    </div>
                </div>`;
            });
        }

        function staffUpdate(id, type) {
            const req = requests.find(x => x.id === id);
            if(type === 'done') {
                const ref = prompt("முடிவு குறிப்பு எண் / விபரம்:");
                if(ref) {
                    req.status = 'StaffDone';
                    req.staffRef = ref;
                    saveAll();
                    renderStaffRequests();
                    alert("அட்மினுக்கு அனுப்பப்பட்டது!");
                }
            } else {
                const reason = prompt("காரணம்:");
                if(reason) {
                    req.status = 'StaffDone'; // Using same status but handled via notes in real app
                    req.rejectReason = reason; // Admin sees this
                    saveAll();
                    renderStaffRequests();
                }
            }
        }

        // --- SERVICES MANAGEMENT ---
        function renderServices() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = '';
            services.forEach((s, i) => {
                tbody.innerHTML += `<tr>
                    <td>${s.cat}</td><td>${s.name}</td><td class="small">${s.docs}</td>
                    <td><button onclick="delService(${i})" class="btn btn-sm btn-danger">&times;</button></td>
                </tr>`;
            });
        }
        function addService() {
            const cat = document.getElementById('newSvcCat').value;
            const name = document.getElementById('newSvcName').value;
            const docs = document.getElementById('newSvcDocs').value;
            if(cat && name) {
                services.push({id: Date.now(), cat, name, docs});
                saveAll();
                renderServices();
                document.getElementById('newSvcName').value = '';
            }
        }
        function delService(i) {
            services.splice(i,1); saveAll(); renderServices();
        }

        // --- STAFF & SETTINGS ---
        function addStaff() {
            const name = document.getElementById('newStaffName').value;
            const id = document.getElementById('newStaffId').value;
            const pass = document.getElementById('newStaffPass').value;
            if(id && pass) {
                staff.push({name, id, pass});
                saveAll(); renderStaff();
                document.getElementById('newStaffId').value = '';
            }
        }
        function renderStaff() {
            document.getElementById('staffList').innerHTML = staff.map((s,i) => 
                `<li class="list-group-item d-flex justify-content-between">${s.name} (${s.id}) 
                <button onclick="staff.splice(${i},1);saveAll();renderStaff()" class="btn btn-sm text-danger">&times;</button></li>`
            ).join('');
        }
        function changeAdminPass() {
            const p = document.getElementById('adminNewPass').value;
            if(p) { config.adminPass = p; saveAll(); alert("பாஸ்வேர்டு மாற்றப்பட்டது"); }
        }

        // --- STATS ---
        function updateStats() {
            document.getElementById('statTotal').innerText = requests.length;
            document.getElementById('statCompleted').innerText = requests.filter(r => r.status === 'Completed').length;
            document.getElementById('statRejected').innerText = requests.filter(r => r.status === 'Rejected').length;
            document.getElementById('statPending').innerText = requests.filter(r => ['Pending','PaymentReq','Processing'].includes(r.status)).length;
            document.getElementById('statStaffPending').innerText = requests.filter(r => r.status === 'Assigned').length;
        }

        // Initialize Customer View
        showCustomer();

    </script>
</body>
</html>